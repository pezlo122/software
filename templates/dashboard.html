{% extends "base.html" %}
{% block title %}Cat√°logo{% endblock %}

{% block content %}

<div class="page-wrapper">

    <h1>Cat√°logo de Pel√≠culas</h1>

    <div class="user-box">
        <span>üë§ {{ user }}</span>
        <a href="/logout" class="logout-btn">Cerrar sesi√≥n</a>
    </div>

    <!-- Buscador -->
    <form action="/dashboard" method="get" class="search-form">
        <input type="text" name="query" placeholder="Buscar en TMDB..." value="{{ query }}">
        <button type="submit">Buscar</button>
    </form>

    <h2>Pel√≠culas Populares (TMDB)</h2>

    <div class="movie-grid">
        {% for movie in movies_api %}
        <div class="movie-card">

            <!-- Imagen -->
            <a href="/movie/{{ movie['id'] }}">
                {% if movie['poster_path'] %}
                <img src="https://image.tmdb.org/t/p/w300{{ movie['poster_path'] }}" alt="{{ movie['title'] }}">
                {% else %}
                <img src="https://via.placeholder.com/300x450?text=No+Image" alt="{{ movie['title'] }}">
                {% endif %}
            </a>

            <!-- T√≠tulo -->
            <h3>{{ movie['title'] }}</h3>
            <p>‚≠ê {{ movie.get('vote_average', 'N/A') }}</p>

            <!-- Like Button -->
            <div class="like-box">
                <button 
                    class="like-btn" 
                    data-movie="{{ movie['id'] }}">
                    ‚ù§Ô∏è
                </button>
                <span class="like-count">{{ likes_map[movie['id']|string] if movie['id']|string in likes_map else 0 }}</span>
            </div>

        </div>
        {% endfor %}
    </div>

    <!-- Paginaci√≥n -->
    <div class="pagination">
        {% if prev_page %}
        <a href="/dashboard?page={{ prev_page }}&query={{ query }}">‚¨Ö Anterior</a>
        {% endif %}
        
        <span>P√°gina {{ page }}</span>

        <a href="/dashboard?page={{ next_page }}&query={{ query }}">Siguiente ‚û°</a>
    </div>

</div>

<!-- JS para likes -->
<script>
document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const movieId = btn.dataset.movie;
        const countSpan = btn.nextElementSibling;

        const res = await fetch(`/api/like/${movieId}`, {
            method: "POST"
        });

        if (res.ok) {
            countSpan.textContent = parseInt(countSpan.textContent) + 1;
        }
    });
});
</script>

{% endblock %}
