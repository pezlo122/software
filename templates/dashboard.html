<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cat√°logo</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="page-wrapper">

        <h1>Cat√°logo de Pel√≠culas</h1>

          <div class="user-box">
        <span>üë§ {{ user if user is defined else 'Usuario' }}</span>
        <a href="/logout" class="logout-btn">Cerrar sesi√≥n</a>
    </div>
</header>

        <!-- Bot√≥n para agregar pel√≠cula personalizada -->
        <a href="/add-movie" class="add-btn">‚ûï Agregar Pel√≠cula</a>

        <!-- Buscador de pel√≠culas en TMDB -->
        <form action="/dashboard" method="get" class="search-form">
            <input
                type="text"
                name="query"
                placeholder="Buscar en TMDB..."
                value="{{ query }}"
            >
            <button type="submit">Buscar</button>
        </form>

        <!-- Secci√≥n de pel√≠culas personalizadas -->
        <h2>Pel√≠culas Personalizadas</h2>
        {% if custom_movies and custom_movies|length > 0 %}
        <div class="movie-grid">
            {% for movie in custom_movies %}
            <div class="movie-card">
                <img src="{{ movie.poster }}" alt="{{ movie.title }}">
                <h3>{{ movie.title }}</h3>
                <p>{{ movie.description }}</p>

                <!-- Bot√≥n que usa la API REST DELETE /api/movie/{id} -->
                <button class="delete-btn" data-movie-id="{{ movie.id }}">
                    üóë Eliminar
                </button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No tienes pel√≠culas personalizadas a√∫n. Usa el bot√≥n "Agregar Pel√≠cula" para crear una.</p>
        {% endif %}

        <!-- Secci√≥n de pel√≠culas obtenidas desde la API de TMDB -->
        <h2>Pel√≠culas Populares (TMDB)</h2>
        <div class="movie-grid">
            {% for movie in movies_api %}
            <a href="/movie/{{ movie.id }}" class="movie-card">
                <img src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}" alt="{{ movie.title }}">
                <h3>{{ movie.title }}</h3>
            </a>
            {% endfor %}
        </div>

        <!-- Controles de paginaci√≥n -->
        <div class="pagination">
            {% if prev_page %}
                <a href="/dashboard?page={{ prev_page }}&query={{ query }}">‚¨Ö Anterior</a>
            {% endif %}
            <span>P√°gina {{ page }}</span>
            {% if next_page %}
                <a href="/dashboard?page={{ next_page }}&query={{ query }}">Siguiente ‚û°</a>
            {% endif %}
        </div>

    </div>

    <!-- Script para manejar clics en los botones de borrar y llamar a la API REST -->
    <script>
    document.addEventListener("click", function (event) {
        const button = event.target.closest(".delete-btn");
        if (!button) {
            return;
        }

        const id = button.getAttribute("data-movie-id");
        if (!id) {
            console.error("No se encontr√≥ data-movie-id en el bot√≥n.");
            return;
        }

        deleteMovie(id);
    });

    async function deleteMovie(id) {
        if (!confirm("¬øSeguro que deseas eliminar esta pel√≠cula?")) {
            return;
        }

        try {
            const response = await fetch("/api/movie/" + id, {
                method: "DELETE"
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                alert("No se pudo eliminar la pel√≠cula. " + (data.detail || ""));
                return;
            }

            window.location.reload();
        } catch (error) {
            console.error(error);
            alert("Ocurri√≥ un error al llamar a la API.");
        }
    }
    </script>
</body>
</html>
